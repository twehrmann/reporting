install.packages(c("KernSmooth", "MASS", "class", "cluster", "codetools", "mgcv"))
###################################################################################################################
############################################Se cargan las linrer?as necesarias#####################################
###################################################################################################################
library(doBy)
library(relimp)# libreria para visualizar la matriz de datos
###################################################################################################################
###############################################Se carga la direcci?n###############################################
###################################################################################################################
#Direcci?n de la cual se leer? el archivo
setwd("C:/Users/oswaldo.carrillo/Desktop/REDD+/An?lisis de Datos/EstratificacionesInceritidumbresEstPob/Ver19_30102013/TAC Junio2014/INEGEI/3 PropagacionError/ScripR/S4-S5/CarbBiomVivaAerea")
###################################################################################################################
#################################################Se carga las bases################################################
###################################################################################################################
BaseCruces<-0
BaseCruces<-read.csv("CrucesSeriresINEGI.csv")
length(BaseCruces$Value)
BaseDinamica<-0
BaseDinamica<-read.csv("Din?mica.csv")
length(BaseDinamica$combinacion_)
TablaFEdefor<-0
TablaFEdegra<-0
TablaFAperma<-0
TablaFArecup<-0
TablaFEdefor<-read.csv("FE_Deforestacion.csv")
TablaFEdeforPrad<-TablaFEdefor
TablaFEdegra<-read.csv("FE_Degradacion.csv")
TablaFArecup<-read.csv("FE_Recuperacion.csv")
TablaFArecupPrad<-TablaFArecup
TablaFArefo<-TablaFArecup
#Se identifica el estrato permamnete
TablaFApermaP<-read.csv("FE_Permanencia.csv")
TablaFApermaP$Estrato2<-substr(x = TablaFApermaP$Estrato, start = 1, stop =as.integer(gregexpr("-",TablaFApermaP$Estrato))-2)
TablaFAperma<-data.frame(Estrato=TablaFApermaP$Estrato2,n=TablaFApermaP$n,FE=TablaFApermaP$FE,U=TablaFApermaP$U)
###################################################################################################################
#se concatenan los tipos de covertura entre S2 y S3
BaseCruces$S2_S3_p<-paste(as.character(BaseCruces$pmn_s4),"-",as.character(BaseCruces$pmn_s5))
#Se agregan las ?reas para las transiciones entre S2 y S3
FunSum <- function(x){c(Sum=sum(x[!is.na(x)]))}
BaseTransiS2S3<-0
BaseTransiS2S3<-summaryBy(BaseCruces$Count ~ BaseCruces$S2_S3_p,
data=BaseCruces, FUN=FunSum,keep.names=TRUE, var.names=c("Areas"))
length(BaseTransiS2S3$S2_S3_p)
#Se identifica el tipo de din?mica en cada estrato de tratsici?n entre S2 y S3
#Se crea una base con las posibles clases de transici?n y los tipos de din?mica
BaseDinamicaDep<-0
BaseDinamicaDep<-data.frame(S2_S3=BaseDinamica$combinacion_,DinamicaG=BaseDinamica$Dinamica)
#Se etiqueta las transiciones de acuerdo a las clases del IPCC
BaseDinamicaDep$Dinamica<-ifelse(BaseDinamicaDep$DinamicaG=="DEFORESTACION","TF-OU",
ifelse(BaseDinamicaDep$DinamicaG=="DEFORESTACION PRADERA","TF-PRA",
ifelse(BaseDinamicaDep$DinamicaG=="DEGRADACION","TF-TFd",
ifelse(BaseDinamicaDep$DinamicaG=="PERDIDA PRADERAS","PRAD-OU",
ifelse(BaseDinamicaDep$DinamicaG=="PERMANENCIA","TF-TF",
ifelse(BaseDinamicaDep$DinamicaG=="PERMANENCIA PRADERA","PRAD-PRAD",
ifelse(BaseDinamicaDep$DinamicaG=="RECUPERACION","TFd-TF",
ifelse(BaseDinamicaDep$DinamicaG=="RECUPERACION PRADERA","OU-PRAD",
ifelse(BaseDinamicaDep$DinamicaG=="REFORESTACION","OU-TF",
ifelse(BaseDinamicaDep$DinamicaG=="NA","NA","NO APLICA"))))))))))
#Se asigna el tipo de din?mica a cada transici?n
BaseTransiS2S3<- merge(BaseTransiS2S3, BaseDinamicaDep, by.x = "S2_S3_p", by.y = "S2_S3",all=TRUE)
length(BaseTransiS2S3$S2_S3_p)
#se filtran los NULL en la variable "Areas"
BaseTransiS2S3<-BaseTransiS2S3[!(is.na(BaseTransiS2S3$Areas)),]
length(BaseTransiS2S3$S2_S3_p)
#Se eliminan el estrato "NO APLICA"
BaseTransiS2S3<-BaseTransiS2S3[BaseTransiS2S3$Dinamica!="NO APLICA",]
length(BaseTransiS2S3$S2_S3_p)
DifSeries<-4
###################################################################################################################
#Se identifica el tipo de estrato al que se le asignar? el FE
###################################################################################################################
#Se desagrega el estrato de transici?n S2-S3
Est1<-substr(x = BaseTransiS2S3$S2_S3_p, start = 1, stop =as.integer(gregexpr("-",BaseTransiS2S3$S2_S3_p))-2)
Est2<-substr(x = BaseTransiS2S3$S2_S3_p, start = as.integer(gregexpr("-",BaseTransiS2S3$S2_S3_p))+2,
stop =nchar(BaseTransiS2S3$S2_S3_p))
#Se identifica el estrato al que se le asignar? el FE
BaseTransiS2S3$EstratoFE<-ifelse(BaseTransiS2S3$Dinamica=="TF-OU",Est1,
ifelse(BaseTransiS2S3$Dinamica=="TF-PRA",Est1,
ifelse(BaseTransiS2S3$Dinamica=="TF-TFd",Est1,
ifelse(BaseTransiS2S3$Dinamica=="NO APLICA","NO APLICA",
ifelse(BaseTransiS2S3$Dinamica=="PRAD-OU",Est1,
ifelse(BaseTransiS2S3$Dinamica=="TF-TF",Est2,
ifelse(BaseTransiS2S3$Dinamica=="PRAD-PRAD",Est2,
ifelse(BaseTransiS2S3$Dinamica=="TFd-TF",Est1,
ifelse(BaseTransiS2S3$Dinamica=="OU-PRAD",Est2,
ifelse(BaseTransiS2S3$Dinamica=="OU-TF",Est2,"Error"))))))))))
#Se crea una variable "Din?mica-Estrato" (al que se le asignar? el FE)
BaseTransiS2S3$DinEstFE<-paste(BaseTransiS2S3$Dinamica,"--",BaseTransiS2S3$EstratoFE)
#Se crean los estratos "Din?mica-Estrato" en las bases con las que se cargar?n los FE
#DEFORESTACI?N (PRAD-OU/TF-OU)
TablaFEdefor$DinEstFE<-ifelse(TablaFEdefor$Estrato=="EOTnL/P"  |
TablaFEdefor$Estrato=="MXnL/P"  |
TablaFEdefor$Estrato=="MXnL/S"  |
TablaFEdefor$Estrato=="P"  |
TablaFEdefor$Estrato=="VHnL/P"
,paste("PRAD-OU","--",TablaFEdefor$Estrato),
paste("TF-OU","--",TablaFEdefor$Estrato))
#DEFORESTACI?N (TF-PRAD)
TablaFEdeforPrad$DinEstFE<- paste("TF-PRA","--",TablaFEdeforPrad$Estrato)
#PERMANENCIA
TablaFAperma$DinEstFE<-ifelse(TablaFAperma$Estrato=="EOTnL/P"  |
TablaFAperma$Estrato=="MXnL/P"  |
TablaFAperma$Estrato=="MXnL/S"  |
TablaFAperma$Estrato=="P"  |
TablaFAperma$Estrato=="VHnL/P"
,paste("PRAD-PRAD","--",TablaFAperma$Estrato),
paste("TF-TF","--",TablaFAperma$Estrato))
#DEGRADACION
TablaFEdegra$DinEstFE<-paste("TF-TFd","--",TablaFEdegra$Estrato)
#RECUPERACI?N
TablaFArecup$DinEstFE<-paste("TFd-TF","--",TablaFArecup$Estrato)
#REFORESTACI?N
TablaFArefo$DinEstFE<-ifelse(TablaFArefo$Estrato=="EOTnL/P"  |
TablaFArefo$Estrato=="MXnL/P"  |
TablaFArefo$Estrato=="MXnL/S"  |
TablaFArefo$Estrato=="P"  |
TablaFArefo$Estrato=="VHnL/P"
,paste("OU-PRAD","--",TablaFArefo$Estrato),
paste("OU-TF","--",TablaFArefo$Estrato))
#Se crea una s?la base de FE y FA con su respectiva din?mica
TablaFEFA<-rbind(TablaFEdefor,TablaFEdeforPrad,TablaFAperma,TablaFEdegra,TablaFArecup,TablaFArefo)
#Se le asigna un FE o FA a cada combinaci?n de "Din?mica" y "Estrato"
BaseTransiS2S3<- merge(BaseTransiS2S3, TablaFEFA, by.x = "DinEstFE", by.y = "DinEstFE",all=TRUE)
#Se estima la Emisi?n/Absorci?n por poligono de cambio/permanencia
#Se anualiza el ?rea
BaseTransiS2S3$AreasAnualizada<-ifelse(BaseTransiS2S3$Dinamica=="TF-OU" | BaseTransiS2S3$Dinamica=="TF-PRA"
| BaseTransiS2S3$Dinamica=="PRAD-OU",BaseTransiS2S3$Areas/DifSeries,
BaseTransiS2S3$Areas)
BaseTransiS2S3$EmisAbs<-BaseTransiS2S3$FE*BaseTransiS2S3$AreasAnualizada
#Se imputa una incertidumbre del Dato de Actividad
BaseTransiS2S3$U_DA<-0
#Se propaga la incertidumbre del FE y DA
BaseTransiS2S3$U_FE_DA<-sqrt(BaseTransiS2S3$U^2+BaseTransiS2S3$U_DA^2)
#Se crea una variable para propagar la incertidumbre de la emisi?n por Clase IPCC
BaseTransiS2S3$Ui2_Ai2<-(BaseTransiS2S3$EmisAbs*BaseTransiS2S3$U_FE_DA)^2
#Se agrega la emisi?n y las incertidumbres a nivel de Clase IPCC
FunSum <- function(x){c(Sum=sum(x[!is.na(x)]))}
TablaEmiAbsS2S3<-0
TablaEmiAbsS2S3<-summaryBy(BaseTransiS2S3$AreasAnualizada + BaseTransiS2S3$EmisAbs + BaseTransiS2S3$Ui2_Ai2 ~ BaseTransiS2S3$Dinamica,
data=BaseTransiS2S3, FUN=FunSum,keep.names=TRUE, var.names=c("Area","EmisionesAbsorciones","Ui2_Ai2"))
length(TablaEmiAbsS2S3$Dinamica)
#Se estima la incertidumbre por clase del IPCC
TablaEmiAbsS2S3$U<-sqrt(TablaEmiAbsS2S3$Ui2_Ai2)/abs(TablaEmiAbsS2S3$EmisionesAbsorciones)
write.csv(TablaEmiAbsS2S3, file = "TablaEmiAbsS4S5.csv")
write.csv(TablaFEFA, file = "TablaFEFA.csv")
#write.csv(BaseTransiS2S3, file = "BaseTransiS2S3.csv")
TablaFEFA
install.packages(c("KernSmooth", "MASS", "Matrix", "Rcpp", "boot", "class", "cluster", "codetools", "foreign", "lattice", "manipulate", "mgcv", "mime", "nlme", "nnet", "raster", "relimp", "rgdal", "rpart", "shiny", "sp", "spatial", "survival"))
library(dCarbono)
setwd("/Volumes/SSD2go_tw/conafor/R Client/cliente_delta_carbon")
BaseT1<-read.csv("Calculo_20140421_CarbonoSitio(2004-2012)_VERSION_19_raices_CASO1y2_TOTALESt1.csv")
BaseT1<-BaseT1[!(is.na(BaseT1$folio)),]
BaseT2<-read.csv("Calculo_20140421_CarbonoSitio(2004-2012)_VERSION_19_raices_CASO1y2_TOTALESt2.csv")
BaseT2<-BaseT2[!(is.na(BaseT2$folio)),]
AreasEstratos<-read.csv("AreasEstratos.csv")
EstratosBUR<-read.csv("1234_pmn45.csv")
EstratosIPCC<-read.csv("EstratosPMN_IPCC.csv")
("Read data files...")
metadata_baset1 = "Calculo_20140421_CarbonoSitio(2004-2012)_VERSION_19_raices_CASO1y2_TOTALESt1.csv"
BaseT1_orig<-read.csv(metadata_baset1,header=TRUE)
BaseVars = vector(mode="list", length=length(names(BaseT1_orig)))
names(BaseVars) = names(BaseT1_orig)
for (i in 1:length(BaseVars) ) {
BaseVars[i] = i
}
getAllVariables <- function() {
return (BaseVars)
}
calcFE <- function(fe_variable_gui, lcc_type_gui) {
print("GUI setting")
print(fe_variable_gui)
print(lcc_type_gui)
##############################Se crean bases de "T1" y "T2 s?lo con las variables de inter?s"###################################
fe_variable=0
if (fe_variable_gui %in% names(BaseVars)) {
print (paste("Using FE variable:", fe_variable_gui, " index:", BaseVars[[fe_variable_gui]]))
BaseT1dep<-data.frame(folio=BaseT1$folio, sitioT1=BaseT1$sitio, FechaT1=BaseT1$levantamiento_fecha_ejecucion,
tipificacionT1=BaseT1$tipificacion, carbono_arbolesT1=BaseT1[,fe_variable_gui])
BaseT2dep<-data.frame(folio=BaseT2$folio, sitioT2=BaseT2$sitio, FechaT2=BaseT2$levantamiento_fecha_ejecucion,
tipificacionT2=BaseT2$tipificacion, carbono_arbolesT2=BaseT2[,fe_variable_gui])
} else {
print(paste("Cannot find EF variable:",fe_variable_gui))
return(0)
}
##############################En cada base se cre una variable de "Conglomerado-Sito"###################################
BaseT1dep$CongSitioT1<-paste(as.character(BaseT1dep$folio),"-",as.character(BaseT1dep$sitioT1))
BaseT2dep$CongSitioT2<-paste(as.character(BaseT2dep$folio),"-",as.character(BaseT2dep$sitioT2))
##################################Se unen las bases "BaseT1dep" y "BaseT2dep"#######################################
BaseT1T2<- merge(BaseT1dep, BaseT2dep, by.x = "CongSitioT1", by.y = "CongSitioT2",all=TRUE)
###################Se identifica el estrato "del BUR" al que pertenece cada sitio en T1 y t2#######################
#Se seleccionan las variables de inter?s de la base de "Estratos"
EstratosBURdep<-data.frame(folio=EstratosBUR$NUMNAL, sitio=EstratosBUR$Sitio, EstratoSlV=EstratosBUR$clave_pmn4,
EstratoSV=EstratosBUR$clave_pmn5)
#En la base "EstratosBURdep" se crea una nueva variable de "Cong-Sitio"
EstratosBURdep$CongSitio<-paste(as.character(EstratosBURdep$folio),"-",as.character(EstratosBURdep$sitio))
#Se unen las bases "BaseT1T2" y "EstratosBURdep"
BaseT1T2<- merge(BaseT1T2, EstratosBURdep, by.x = "CongSitioT1", by.y = "CongSitio",all=TRUE)
###################Se identifica el estrato "del IPCC" al que pertenece cada sitio en T1 y t2#######################
BaseT1T2<- merge(BaseT1T2, EstratosIPCC, by.x = "EstratoSlV", by.y = "pf_redd_clave_subcat_leno_pri_sec",all=TRUE)
#############################Se filtran los sitios reportados como "Iniciales" en T1 y T2############################
#se filtra todas las UMP cuya "tipificaci?n" es "Inicial", "Reemplazo" o "Monitoreo" en T1
BaseT1T2=BaseT1T2[BaseT1T2$tipificacionT1=="Inicial" |
#              BaseT1T2$tipificacionT1=="Reemplazo" |
BaseT1T2$tipificacionT1=="Monitoreo",]
#se filtra todas las USM cuya "tipificaci?n" es "Inicial", "Reemplazo" o "Omitido-Remuestreo" en T2
BaseT1T2=BaseT1T2[BaseT1T2$tipificacionT2=="Inicial" |
#              BaseT1T2$tipificacionT2=="Reemplazo" |
BaseT1T2$tipificacionT2=="Omitido-Remuestreo" & BaseT1T2$tipificacionT1=="Monitoreo" & BaseT1T2$pf_redd_ipcc_2003=="Praderas",]
######################Se filtran las "Tierras Forestales" o "Praderas" definidas por el IPCC########################
BaseT1T2=BaseT1T2[BaseT1T2$pf_redd_ipcc_2003=="Tierras Forestales" | BaseT1T2$pf_redd_ipcc_2003=="Praderas",]
#############Se imputan los 0 en los conglomerdos reportados "Monitoreo" y que ten?an "Pradera" en T1 y T2#########
BaseT1T2$CarbAerVivT1<-ifelse(BaseT1T2$tipificacionT1=="Monitoreo" & BaseT1T2$pf_redd_ipcc_2003=="Praderas",0,
as.numeric(as.character(BaseT1T2$carbono_arbolesT1)))
BaseT1T2$CarbAerVivT2<-ifelse(BaseT1T2$tipificacionT1=="Monitoreo" & BaseT1T2$pf_redd_ipcc_2003=="Praderas"&
BaseT1T2$tipificacionT2=="Omitido-Remuestreo",0, as.numeric(as.character(BaseT1T2$carbono_arbolesT2)))
##############Se filtran los sitios que en T1 y/o en T2 contienen valores "NA" en el carbono estimado#############
#Se filtran todos los "NA" de la variable "CarbAerViv" en T1
BaseT1T2<-BaseT1T2[!(is.na(BaseT1T2$CarbAerVivT1)),]
#Se filtran todos los "NA" de la variable "CarbAerVivT2correg" en T2
BaseT1T2<-BaseT1T2[!(is.na(BaseT1T2$CarbAerVivT2)),]
##############################Se filtran las transiciones de las zonas de permanencia###############################
#Se crea una variable de "Estratos de Transici?n"
BaseT1T2$EstTrnsT1T2<-paste(as.character(BaseT1T2$EstratoSlV),"-",as.character(BaseT1T2$EstratoSV))
#Se fltran los sitios que no son de permanencia
BaseT1T2=BaseT1T2[
BaseT1T2$EstTrnsT1T2=="ACUI - ACUI"  |
BaseT1T2$EstTrnsT1T2=="AGR - AGR"  |
BaseT1T2$EstTrnsT1T2=="AH - AH"  |
BaseT1T2$EstTrnsT1T2=="BC - BC"  |
BaseT1T2$EstTrnsT1T2=="BCO/P - BCO/P"  |
BaseT1T2$EstTrnsT1T2=="BCO/S - BCO/S"  |
BaseT1T2$EstTrnsT1T2=="BE/P - BE/P"  |
BaseT1T2$EstTrnsT1T2=="BE/S - BE/S"  |
BaseT1T2$EstTrnsT1T2=="BM/P - BM/P"  |
BaseT1T2$EstTrnsT1T2=="BM/S - BM/S"  |
BaseT1T2$EstTrnsT1T2=="EOTL/P - EOTL/P"  |
BaseT1T2$EstTrnsT1T2=="EOTL/S - EOTL/S"  |
BaseT1T2$EstTrnsT1T2=="EOTnL/P - EOTnL/P"  |
BaseT1T2$EstTrnsT1T2=="H2O - H2O"  |
BaseT1T2$EstTrnsT1T2=="MXL/P - MXL/P"  |
BaseT1T2$EstTrnsT1T2=="MXL/S - MXL/S"  |
BaseT1T2$EstTrnsT1T2=="MXnL/P - MXnL/P"  |
BaseT1T2$EstTrnsT1T2=="MXnL/S - MXnL/S"  |
BaseT1T2$EstTrnsT1T2=="OT - OT"  |
BaseT1T2$EstTrnsT1T2=="P - P"  |
BaseT1T2$EstTrnsT1T2=="SC/P - SC/P"  |
BaseT1T2$EstTrnsT1T2=="SC/S - SC/S"  |
BaseT1T2$EstTrnsT1T2=="SP/P - SP/P"  |
BaseT1T2$EstTrnsT1T2=="SP/S - SP/S"  |
BaseT1T2$EstTrnsT1T2=="SSC/P - SSC/P"  |
BaseT1T2$EstTrnsT1T2=="SSC/S - SSC/S"  |
BaseT1T2$EstTrnsT1T2=="VHL/P - VHL/P"  |
BaseT1T2$EstTrnsT1T2=="VHL/S - VHL/S"  |
BaseT1T2$EstTrnsT1T2=="VHnL/P - VHnL/P",]
#Se identifica el ?rea de cada estrato
#Se identifica el Estrato
Estrato<-substr(x = AreasEstratos$Cves4_Cves5_pmn,
start = 1, stop =as.integer(gregexpr("-",AreasEstratos$Cves4_Cves5_pmn))-2)
AreaHa<-AreasEstratos$AreasCves4_Cves5_pmn
AreasEstratos<-data.frame(Estrato,AreaHa)
#####################################Se imputa el ?rea de muestreo a nivel de sitio################################
ai=rep(0.04,nrow(BaseT1T2))
t1=BaseT1T2$FechaT1
t2=BaseT1T2$FechaT2
conglomerado=BaseT1T2$folio.x
estrato=BaseT1T2$EstTrnsT1T2
y_t1=BaseT1T2$CarbAerVivT1
y_t2=BaseT1T2$CarbAerVivT2
#rm(BaseT1T2)
out=Cambios(y_t1=y_t1, y_t2=y_t2, t1=t1, t2=t2, conglomerado=conglomerado,
estrato=estrato, ai=ai, AreasEstratos=AreasEstratos)
return(out)
}
print ("BUR")
data=calcFE("carbono_arboles","BUR")
write.csv(data, file = "FE_pot_carbono_arboles_bur.csv")
View(EstratosIPCC)
View(EstratosBUR)
install.packages("RPostgreSQL")
